<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        body { font-family: 'Inter', Arial, sans-serif; margin: 0; background-color: #f0f4f8; }
        .container { max-width: 1400px; margin: 20px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .header { text-align: center; color: #1e3a8a; margin-bottom: 40px; }
        .header h1 { font-size: 2.5em; margin-bottom: 5px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: #e0f2f1; padding: 15px; border-left: 5px solid #009688; border-radius: 8px; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .stat-card.warning { background: #fff8e1; border-left-color: #ff9800; }
        .stat-card.error { background: #ffebee; border-left-color: #f44336; }
        .stat-value { font-size: 28px; font-weight: bold; color: #1e3a8a; }
        .stat-label { font-size: 14px; color: #555; margin-top: 5px; }
        .controls { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #e0e0e0; }
        .button { background: #009688; color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; margin: 5px 5px 5px 0; transition: background 0.3s, transform 0.1s; font-weight: 600; }
        .button:hover:not(:disabled) { background: #00796b; transform: translateY(-1px); }
        .button.secondary { background: #607d8b; }
        .button.secondary:hover:not(:disabled) { background: #455a64; }
        .button.danger { background: #e57373; }
        .button.danger:hover:not(:disabled) { background: #d32f2f; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .section { margin: 40px 0; }
        .section h3 { color: #1e3a8a; border-bottom: 3px solid #009688; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.5em; }
        .log { background: #f0f4f8; border: 1px solid #b0bec5; padding: 15px; border-radius: 6px; height: 180px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap; color: #37474f; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .control-card { background: #f5f5f5; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #37474f; font-size: 0.9em;}
        .input-group input, .input-group select { width: 100%; padding: 8px; border: 1px solid #b0bec5; border-radius: 4px; box-sizing: border-box; }
        .component-list { max-height: 400px; overflow-y: auto; padding-right: 15px; }
        .component-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px dashed #cfd8dc; }
        .component-item strong { color: #1e3a8a; }
        .control-action-group { display: flex; gap: 5px; align-items: center; }
        .control-action-group input[type="number"] { width: 80px; text-align: right; margin-right: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ title }}</h1>
            <p>Unified Gas Pipeline Digital Twin Simulator</p>
            <p><span class="status-indicator status-online"></span>System Online - GasLib-40 Ready</p>
        </div>
        
        <!-- System Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ network_count }}</div>
                <div class="stat-label">Networks</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ node_count }}</div>
                <div class="stat-label">Nodes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ pipe_count }}</div>
                <div class="stat-label">Pipes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ valve_count }}</div>
                <div class="stat-label">Valves</div>
            </div>
             <div class="stat-card">
                <div class="stat-value">{{ compressor_count }}</div>
                <div class="stat-label">Compressors</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ plc_count }}</div>
                <div class="stat-label">PLCs</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ sensor_count }}</div>
                <div class="stat-label">Sensors</div>
            </div>
            <div class="stat-card {% if active_alarms > 0 %}warning{% else %}stat-card{% endif %}">
                <div class="stat-value">{{ active_alarms }}</div>
                <div class="stat-label">Active Alarms</div>
            </div>
        </div>
        
        <!-- Simulation Controls -->
        <div class="section">
            <h3>Simulation Management</h3>
            <div class="controls">
                <div class="control-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="simulation-params">
                        <div class="input-group">
                            <label for="duration">Duration (seconds):</label>
                            <input type="number" id="duration" value="600" min="1" max="3600">
                        </div>
                        <div class="input-group">
                            <label for="timestep">Time Step (seconds):</label>
                            <input type="number" id="timestep" value="1.0" min="0.1" max="60" step="0.1">
                        </div>
                         <div class="input-group">
                            <label for="network">Network:</label>
                            <select id="network">
                                {% for network in networks %}
                                <option value="{{ network.id }}">{{ network.name }}</option>
                                {% empty %}
                                <option value="">No networks loaded</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                     <div style="align-self: end;">
                        <button class="button" onclick="loadGasLibNetwork()">Load GasLib-40 Network</button>
                        <button class="button secondary" onclick="refreshNetworkData()">Refresh Network Data</button>
                        <hr style="margin: 10px 0;">
                        <button class="button" onclick="startSimulation()">Start Simulation</button>
                        <button class="button danger" onclick="stopSimulation()">Stop Simulation</button>
                        <button class="button secondary" onclick="checkStatus()">Check Status</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Direct Control Section -->
        <div class="section">
            <h3>Direct Component Control (Manual Override)</h3>
            <div class="control-grid">
                
                <!-- Valve Control -->
                <div class="control-card">
                    <h4>Valves ({{ valve_count }})</h4>
                    <p style="font-size: 0.8em; color: #546e7a; margin-bottom: 10px;">Set position (0-100%). Use AUTO to revert to PLC control.</p>
                    <div class="component-list">
                        {% for valve in valves %}
                        <div class="component-item">
                            <span><strong>{{ valve.valve_id }}</strong> ({{ valve.pipe.pipe_id }})<br>Current: {{ valve.position|floatformat:1 }}% | Set: {% if valve.set_position >= 0 %}<span style="color: #d32f2f;">{{ valve.set_position|floatformat:1 }}% (MAN)</span>{% else %}<span style="color: #009688;">Auto</span>{% endif %}</span>
                            <div class="control-action-group">
                                <input type="number" id="valve_pos_{{ valve.valve_id }}" value="50" min="0" max="100" step="1" title="Position 0-100%">
                                <button class="button" onclick="setValvePosition('{{ valve.valve_id }}')">SET</button>
                                <button class="button secondary" onclick="setValveAuto('{{ valve.valve_id }}')">AUTO</button>
                            </div>
                        </div>
                        {% empty %}
                        <p>No valves initialized. Start simulation to initialize components.</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Compressor Control -->
                <div class="control-card">
                    <h4>Compressors ({{ compressor_count }})</h4>
                    <p style="font-size: 0.8em; color: #546e7a; margin-bottom: 10px;">Command (ON/OFF) and Speed (RPM). Use AUTO to revert to PLC control.</p>
                    <div class="component-list">
                        {% for comp in compressors %}
                        <div class="component-item">
                            <span><strong>{{ comp.compressor_id }}</strong> ({{ comp.node.node_id }})<br>Status: {{ comp.get_status_display }} | Speed: {{ comp.speed|floatformat:0 }} RPM<br>Set Cmd: {{ comp.set_command }} | Set Speed: {% if comp.set_speed >= 0 %}{{ comp.set_speed|floatformat:0 }} RPM{% else %}Auto{% endif %}</span>
                            <div class="control-action-group">
                                <input type="number" id="comp_speed_{{ comp.compressor_id }}" value="10000" min="0" max="{{ comp.max_speed|floatformat:0 }}" step="100" title="Target Speed (RPM)">
                                <button class="button" onclick="setCompressorCommand('{{ comp.compressor_id }}', 'ON')">ON</button>
                                <button class="button danger" onclick="setCompressorCommand('{{ comp.compressor_id }}', 'OFF')">OFF</button>
                                <button class="button secondary" onclick="setCompressorCommand('{{ comp.compressor_id }}', 'AUTO')">AUTO</button>
                            </div>
                        </div>
                        {% empty %}
                        <p>No compressors initialized. Start simulation to initialize components.</p>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Node Setpoint Control -->
                <div class="control-card">
                    <h4>Node Setpoints (Sources/Sinks)</h4>
                    <p style="font-size: 0.8em; color: #546e7a; margin-bottom: 10px;">Set Pressure (bar) or Flow (x1000m³/h) at source/sink nodes.</p>
                    <div class="component-list">
                         {% for node in control_nodes %}
                        <div class="component-item" style="flex-wrap: wrap;">
                            <div style="width: 100%;">
                                <strong>{{ node.node_id }}</strong> ({{ node.get_node_type_display }})
                                <br>P Set: {{ node.set_pressure|floatformat:1 }} bar | F Set: {{ node.set_flow|floatformat:1 }} x1000m³/h
                            </div>
                            <div class="control-action-group" style="width: 100%; margin-top: 5px;">
                                <input type="number" id="node_p_{{ node.node_id }}" value="{{ node.set_pressure|floatformat:1 }}" min="{{ node.pressure_min|floatformat:1 }}" max="{{ node.pressure_max|floatformat:1 }}" step="1" title="Set Pressure (bar)">
                                <button class="button" onclick="setNodeSetpoint('{{ node.node_id }}', 'P')">Set P</button>
                                <input type="number" id="node_f_{{ node.node_id }}" value="{{ node.set_flow|floatformat:1 }}" min="{{ node.flow_min|floatformat:1 }}" max="{{ node.flow_max|floatformat:1 }}" step="1" title="Set Flow (x1000m³/h)">
                                <button class="button" onclick="setNodeSetpoint('{{ node.node_id }}', 'F')">Set F</button>
                            </div>
                        </div>
                        {% empty %}
                        <p>No control nodes found.</p>
                        {% endfor %}
                    </div>
                </div>

            </div>
        </div>

        <!-- PLC Status -->
        <div class="section">
            <h3>PLC Status Monitor</h3>
            <div class="controls">
                <button class="button secondary" onclick="refreshPLCStatus()">Refresh PLC Status</button>
                <div id="plcStatus" class="log">
                    Click "Refresh PLC Status" to view PLC information...
                </div>
            </div>
        </div>
        
        <!-- Sensor Readings -->
        <div class="section">
            <h3>Live Sensor Readings</h3>
            <div class="controls">
                <button class="button secondary" onclick="refreshSensorReadings()">Refresh Sensor Readings</button>
                <div id="sensorReadings" class="log">
                    Click "Refresh Sensor Readings" to view current sensor data...
                </div>
            </div>
        </div>
        
        <!-- Active Alarms -->
        <div class="section">
            <h3>Active Alarms</h3>
            <div class="controls">
                <button class="button secondary" onclick="refreshAlarms()">Refresh Alarms</button>
                <div id="alarmsList" class="alarm-list">
                    {% if active_alarms > 0 %}
                    <p style="padding: 15px;">{{ active_alarms }} active alarms - Click "Refresh Alarms" to view details</p>
                    {% else %}
                    <p style="padding: 15px;">No active alarms</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Results Display -->
        <div class="section">
            <h3>System Messages</h3>
            <div id="result" class="log">
                System ready. Use the controls above to manage the gas pipeline simulation.
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let currentSimulationId = null;
        
        function logMessage(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            // Check if adding the new log entry will exceed max length (e.g., 5000 chars)
            if (resultDiv.textContent.length + logEntry.length > 5000) {
                // Keep only the last 4000 chars roughly to avoid performance issues
                const lines = resultDiv.textContent.split('\n');
                const newLines = lines.slice(Math.max(0, lines.length - 30)); 
                resultDiv.textContent = newLines.join('\n');
            }
            
            resultDiv.textContent += logEntry;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        // --- New Control Functions ---
        
        function setValvePosition(valveId) {
            const positionInput = document.getElementById(`valve_pos_${valveId}`);
            const position = parseFloat(positionInput.value);
            
            if (isNaN(position) || position < 0 || position > 100) {
                logMessage('✗ Invalid valve position. Must be 0-100.', 'error');
                return;
            }
            
            logMessage(`Setting Valve ${valveId} position to ${position}% (Manual)...`);
            
            fetch(`/api/control/valve/${valveId}/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ position: position })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    logMessage(`✓ ${data.message}`);
                    setTimeout(() => window.location.reload(), 500); // Quick refresh to show state
                } else {
                    logMessage(`✗ Error setting valve: ${data.message}`, 'error');
                }
            })
            .catch(error => logMessage(`✗ Network Error: ${error.message}`, 'error'));
        }

        function setValveAuto(valveId) {
            logMessage(`Setting Valve ${valveId} control to Auto (PLC)...`);
            
            fetch(`/api/control/valve/${valveId}/auto/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    logMessage(`✓ ${data.message}`);
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    logMessage(`✗ Error setting valve to auto: ${data.message}`, 'error');
                }
            })
            .catch(error => logMessage(`✗ Network Error: ${error.message}`, 'error'));
        }
        
        function setCompressorCommand(compressorId, command) {
            const speedInput = document.getElementById(`comp_speed_${compressorId}`);
            const speed = parseFloat(speedInput.value);

            let payload = { command: command };
            
            if (command === 'ON') {
                if (isNaN(speed) || speed <= 0) {
                    logMessage('✗ Invalid speed for ON command.', 'error');
                    return;
                }
                payload.speed = speed;
            }
            
            logMessage(`Setting Compressor ${compressorId} command to ${command}...`);

            fetch(`/api/control/compressor/${compressorId}/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    logMessage(`✓ ${data.message}`);
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    logMessage(`✗ Error setting compressor: ${data.message}`, 'error');
                }
            })
            .catch(error => logMessage(`✗ Network Error: ${error.message}`, 'error'));
        }

        function setNodeSetpoint(nodeId, type) {
            let payload = {};
            let setpoint;
            
            if (type === 'P') {
                const pressureInput = document.getElementById(`node_p_${nodeId}`);
                setpoint = parseFloat(pressureInput.value);
                if (isNaN(setpoint) || setpoint < 0) {
                    logMessage('✗ Invalid pressure setpoint.', 'error');
                    return;
                }
                payload.set_pressure = setpoint;
                logMessage(`Setting Node ${nodeId} Pressure Setpoint to ${setpoint} bar...`);
            } else if (type === 'F') {
                const flowInput = document.getElementById(`node_f_${nodeId}`);
                setpoint = parseFloat(flowInput.value);
                 if (isNaN(setpoint) || setpoint < 0) {
                    logMessage('✗ Invalid flow setpoint.', 'error');
                    return;
                }
                payload.set_flow = setpoint;
                logMessage(`Setting Node ${nodeId} Flow Setpoint to ${setpoint} x1000m³/h...`);
            } else {
                return;
            }
            
            fetch(`/api/control/node/${nodeId}/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    logMessage(`✓ ${data.message}`);
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    logMessage(`✗ Error setting node setpoint: ${data.message}`, 'error');
                }
            })
            .catch(error => logMessage(`✗ Network Error: ${error.message}`, 'error'));
        }

        // --- Existing Functions (retained) ---
        
        function loadGasLibNetwork() {
            logMessage('Loading GasLib-40 network...');
            
            fetch('/api/network/load/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    logMessage(`✓ ${data.message} - ${data.nodes} nodes, ${data.pipes} pipes`);
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    logMessage(`✗ Error: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                logMessage(`✗ Network error: ${error.message}`, 'error');
            });
        }
        
        function startSimulation() {
            const duration = parseInt(document.getElementById('duration').value);
            const timestep = parseFloat(document.getElementById('timestep').value);
            const networkSelect = document.getElementById('network');
            const networkId = networkSelect.value;
            
            if (!networkId) {
                logMessage('✗ Please select a network first', 'error');
                return;
            }
            
            logMessage(`Starting simulation: ${duration}s duration, ${timestep}s timestep...`);
            
            fetch('/api/simulation/start/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    network_id: parseInt(networkId),
                    duration: duration,
                    time_step: timestep
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    currentSimulationId = data.simulation_id;
                    logMessage(`✓ Simulation ${data.run_id} started successfully`);
                    logMessage(`  Network: ${data.network}`);
                    logMessage(`  Duration: ${data.duration}s | Time Step: ${data.time_step}s`);
                } else {
                    logMessage(`✗ Error: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                logMessage(`✗ Error starting simulation: ${error.message}`, 'error');
            });
        }
        
        function stopSimulation() {
            logMessage('Stopping simulation...');
            
            fetch('/api/simulation/stop/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    logMessage('✓ Simulation stopped successfully');
                    currentSimulationId = null;
                } else {
                    logMessage(`✗ Error: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                logMessage(`✗ Error stopping simulation: ${error.message}`, 'error');
            });
        }
        
        function checkStatus() {
            fetch('/api/simulation/status/')
            .then(response => response.json())
            .then(data => {
                logMessage('=== System Status ===');
                logMessage(`Status: ${data.status}`);
                logMessage(`Networks: ${data.networks} | Nodes: ${data.nodes} | Pipes: ${data.pipes}`);
                logMessage(`Valves: ${data.valves} | Compressors: ${data.compressors} | PLCs: ${data.plcs}`);
                logMessage(`Active Alarms: ${data.active_alarms}`);
                logMessage(`Engine Running: ${data.engine_running}`);
                
                if (data.latest_simulation) {
                    const sim = data.latest_simulation;
                    logMessage(`Latest Sim: ${sim.run_id} (${sim.status}) | Steps: ${sim.total_steps}`);
                }
            })
            .catch(error => {
                logMessage(`✗ Error getting status: ${error.message}`, 'error');
            });
        }
        
        function refreshNetworkData() {
            const networkSelect = document.getElementById('network');
            const networkId = networkSelect.value;
            
            if (!networkId) {
                logMessage('Please select a network first', 'warning');
                return;
            }
            
            fetch(`/api/network/${networkId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    logMessage(`Network ${data.network.name}: ${data.nodes.length} nodes, ${data.pipes.length} pipes`);
                    logMessage(`Sensors: ${data.sensors.length} | PLCs: ${data.plcs.length}`);
                } else {
                    logMessage(`✗ Error: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                logMessage(`✗ Error: ${error.message}`, 'error');
            });
        }
        
        function refreshPLCStatus() {
            fetch('/api/plcs/status/')
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('plcStatus');
                if (data.status === 'success') {
                    let content = `=== PLC Status (${data.total_active} active) ===\n`;
                    data.plcs.forEach(plc => {
                        content += `${plc.id} (${plc.type}) @ ${plc.node}\n`;
                        content += `  Active: ${plc.active} | Inputs: ${plc.inputs} | Outputs: ${plc.outputs}\n`;
                        content += `  Alarms: ${plc.active_alarms} | Last Scan: ${plc.last_scan ? new Date(plc.last_scan).toLocaleTimeString() : 'Never'}\n\n`;
                    });
                    statusDiv.textContent = content;
                } else {
                    statusDiv.textContent = `Error: ${data.message}`;
                }
            })
            .catch(error => {
                document.getElementById('plcStatus').textContent = `Error: ${error.message}`;
            });
        }
        
        function refreshSensorReadings() {
            fetch('/api/sensors/readings/')
            .then(response => response.json())
            .then(data => {
                const readingsDiv = document.getElementById('sensorReadings');
                if (data.status === 'success') {
                    let content = `=== Sensor Readings (${data.total_active} active) ===\n`;
                    data.sensors.forEach(sensor => {
                        content += `${sensor.id} (${sensor.type}) @ ${sensor.location}\n`;
                        content += `  Value: ${sensor.value} ${sensor.unit} | Quality: ${sensor.quality}\n`;
                        content += `  Last Update: ${new Date(sensor.last_update).toLocaleTimeString()}\n\n`;
                    });
                    readingsDiv.textContent = content;
                } else {
                    readingsDiv.textContent = `Error: ${data.message}`;
                }
            })
            .catch(error => {
                document.getElementById('sensorReadings').textContent = `Error: ${error.message}`;
            });
        }
        
        function refreshAlarms() {
            fetch('/api/alarms/')
            .then(response => response.json())
            .then(data => {
                const alarmsDiv = document.getElementById('alarmsList');
                if (data.status === 'success') {
                    if (data.alarms.length === 0) {
                        alarmsDiv.innerHTML = '<p style="padding: 15px;">No active alarms</p>';
                    } else {
                        let content = '';
                        data.alarms.forEach(alarm => {
                            content += `<div class="alarm-item alarm-${alarm.severity.toLowerCase()}">`;
                            content += `<strong>${alarm.alarm_id}</strong> - ${alarm.severity}`;
                            content += `<br>PLC: ${alarm.plc_id} (${alarm.plc_type}) @ ${alarm.node_id}`;
                            content += `<br>Message: ${alarm.message}`;
                            content += `<br>Time: ${new Date(alarm.timestamp).toLocaleString()}`;
                            content += `<br><button class="button secondary" style="background: #4db6ac; margin-top: 5px;" onclick="acknowledgeAlarm(${alarm.id})">Acknowledge</button>`;
                            content += `</div>`;
                        });
                        alarmsDiv.innerHTML = content;
                    }
                } else {
                    alarmsDiv.innerHTML = `<p style="padding: 15px;">Error: ${data.message}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('alarmsList').innerHTML = `<p style="padding: 15px;">Error: ${error.message}</p>`;
            });
        }
        
        function acknowledgeAlarm(alarmId) {
            fetch(`/api/alarms/${alarmId}/acknowledge/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({acknowledged_by: 'Web User'})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    logMessage(`✓ ${data.message}`);
                    refreshAlarms(); // Refresh the alarm list
                } else {
                    logMessage(`✗ Error: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                logMessage(`✗ Error acknowledging alarm: ${error.message}`, 'error');
            });
        }
        
        // Auto-refresh functions
        function startAutoRefresh() {
            // Refresh main status every 30 seconds
            setInterval(checkStatus, 30000);
            
            // Refresh component statuses every 10 seconds
            setInterval(refreshPLCStatus, 10000);
            setInterval(refreshSensorReadings, 10000);
            setInterval(refreshAlarms, 10000);
            
            // Reload page periodically (e.g., every 5 minutes) for full component list update if needed
            // setInterval(() => window.location.reload(), 300000); 
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('Gas Pipeline Simulator initialized');
            checkStatus();
            startAutoRefresh();
        });
    </script>
</body>
</html>
